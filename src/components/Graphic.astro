---
import { readFileSync } from 'node:fs';
import { join } from 'node:path';

type Props = {
    url: string;
    isThemedSvg?: boolean;
    alt?: string;
    title?: string;
    class?: string;
};

const props: Props = Astro.props;
const { url, isThemedSvg = false, alt = '', title, class: className } = props;

function resolvePublicPath(src: string): string | null {
    if (!src.startsWith('/')) {
        return null;
    }
    const trimmed = src.startsWith('/portfolio/') ? src.slice('/portfolio/'.length) : src.slice(1);
    return join(process.cwd(), 'public', trimmed);
}

type SvgTagMatch = {
    tag: string;
    start: number;
    end: number;
};

function findSvgTag(markup: string): SvgTagMatch | null {
    const start = markup.indexOf('<svg');
    if (start === -1) {
        return null;
    }

    let inQuote: '"' | "'" | null = null;
    for (let i = start; i < markup.length; i += 1) {
        const char = markup[i];
        if (inQuote) {
            if (char === inQuote) {
                inQuote = null;
            }
            continue;
        }
        if (char === '"' || char === "'") {
            inQuote = char;
            continue;
        }
        if (char === '>') {
            return {
                tag: markup.slice(start, i + 1),
                start,
                end: i + 1,
            };
        }
    }

    return null;
}

function decorateSvg(markup: string, cssClass?: string, label?: string): string {
    const match = findSvgTag(markup);
    if (!match) {
        return markup;
    }

    let tag = match.tag;
    if (cssClass) {
        const classMatch = tag.match(/\bclass\s*=\s*(['"])(.*?)\1/);
        if (classMatch) {
            const existing = classMatch[2].trim();
            const nextClass = existing ? `${existing} ${cssClass}` : cssClass;
            tag = tag.replace(classMatch[0], `class="${nextClass}"`);
        } else {
            tag = tag.replace('<svg', `<svg class="${cssClass}"`);
        }
    }

    if (label && !/\baria-label\s*=/.test(tag)) {
        tag = tag.replace('<svg', `<svg aria-label="${label}" role="img"`);
    }

    return `${markup.slice(0, match.start)}${tag}${markup.slice(match.end)}`;
}

let svgMarkup: string | null = null;
if (isThemedSvg && url.endsWith('.svg')) {
    const svgPath = resolvePublicPath(url);
    if (svgPath) {
        try {
            const raw = readFileSync(svgPath, 'utf8');
            svgMarkup = decorateSvg(raw, className, title ?? alt);
        } catch {
            svgMarkup = null;
        }
    }
}
---

{
    svgMarkup ? (
        <Fragment set:html={svgMarkup} />
    ) : (
        <img src={url} alt={alt} title={title} class={className} loading='lazy' />
    )
}
