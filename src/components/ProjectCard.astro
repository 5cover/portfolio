---
import Graphic from './Graphic.astro';
import LinkList from './LinkList.astro';
import { detailHref, pageHref } from '../lib/routes';
import { formatDate } from '../lib/date';
import type {
  AnchorEntry,
  LocalizedProjectEntry,
  LocalizedTagEntry,
} from '../lib/content';

function capitalize(value: string): string {
  return value.length > 0 ? value[0].toUpperCase() + value.slice(1) : value;
}

function formatTitle(fmt: string, title: string): string {
  return fmt.replace('%s', title);
}

type Props = {
  lang: string;
  langLabels: {
    ongoing: string;
    fmtTitle: string;
  };
  project: LocalizedProjectEntry['data'];
  tagsById: Record<string, LocalizedTagEntry['data']>;
  anchorsById: Record<string, AnchorEntry['data']>;
  headingLevel?: number;
};

const props: Props = Astro.props;
const { lang, langLabels, project, tagsById, anchorsById, headingLevel = 3 } = props;
const logoTitle = formatTitle(langLabels.fmtTitle, project.title);
const startDate = project.startDate;
const endDate = project.endDate;
const startLabel = startDate ? formatDate(startDate, lang) : '';
const endLabel = endDate ? formatDate(endDate, lang) : '';
const context = project.context ? capitalize(project.context) : '';
const backgroundStyle = project.background
  ? `--bg-img-card: url(${project.background})`
  : undefined;
---
<li style={backgroundStyle}>
  <ul class="list-rect">
    {project.tags.map((tagId) => (
      <li>
        <a href={`${pageHref(lang, 'projects')}?tag=${tagId}`} set:html={tagsById[tagId]?.title ?? tagId}></a>
      </li>
    ))}
  </ul>
  {project.logo ? (
    <Graphic
      url={project.logo.url}
      isThemedSvg={project.logo.isThemedSvg}
      alt={logoTitle}
      title={logoTitle}
      class="logo"
    />
  ) : null}
  {headingLevel === 1 ? (
    <h1><a class="foil" href={detailHref(lang, 'projects', project.id)} set:html={project.title}></a></h1>
  ) : headingLevel === 2 ? (
    <h2><a class="foil" href={detailHref(lang, 'projects', project.id)} set:html={project.title}></a></h2>
  ) : headingLevel === 4 ? (
    <h4><a class="foil" href={detailHref(lang, 'projects', project.id)} set:html={project.title}></a></h4>
  ) : headingLevel === 5 ? (
    <h5><a class="foil" href={detailHref(lang, 'projects', project.id)} set:html={project.title}></a></h5>
  ) : headingLevel === 6 ? (
    <h6><a class="foil" href={detailHref(lang, 'projects', project.id)} set:html={project.title}></a></h6>
  ) : (
    <h3><a class="foil" href={detailHref(lang, 'projects', project.id)} set:html={project.title}></a></h3>
  )}
  {startDate ? (
    <small class="status">
      <time datetime={startDate}>{startLabel}</time> &ndash;{' '}
      {endDate ? <time datetime={endDate}>{endLabel}</time> : langLabels.ongoing}
    </small>
  ) : null}
  {context ? <small class="context">{context}</small> : null}
  <p class="abstract" set:html={project.abstract} />
  {project.links.length > 0 ? (
    <LinkList links={project.links} anchorsById={anchorsById} />
  ) : null}
</li>
