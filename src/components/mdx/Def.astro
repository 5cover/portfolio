---
import { getDefinitions } from '../../lib/content';
import type { DefinitionLocalizedData } from '../../lib/content';

type DefinitionIndex = Record<string, DefinitionLocalizedData>;

const definitionCache = new Map<string, DefinitionIndex>();

async function getDefinitionIndex(lang: string): Promise<DefinitionIndex> {
  const cached = definitionCache.get(lang);
  if (cached) {
    return cached;
  }

  const entries = await getDefinitions(lang);
  const index = entries.reduce<DefinitionIndex>((acc, entry) => {
    acc[entry.data.id] = entry.data;
    return acc;
  }, {});
  definitionCache.set(lang, index);
  return index;
}

interface Props {
  id: string;
  href?: string;
  class?: string;
}

const { id, href, class: className } = Astro.props;
const langParam = typeof Astro.params?.lang === 'string' ? Astro.params.lang : 'fr';
const definitionsById = await getDefinitionIndex(langParam);
const definition = definitionsById[id];
const resolvedHref = href ?? definition?.wiki;

if (!resolvedHref) {
  throw new Error(`Missing definition href for ${id}`);
}

const label = definition?.name.abbr ?? definition?.name.short ?? definition?.name.full ?? id;
const classes = ['link', 'definition-tooltip-trigger', className].filter(Boolean).join(' ');
const isExternal = resolvedHref.startsWith('http://') || resolvedHref.startsWith('https://');
---
<a
  href={resolvedHref}
  class={classes}
  data-definition-id={id}
  {...(isExternal ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
>
  <slot>{label}</slot>
</a>
