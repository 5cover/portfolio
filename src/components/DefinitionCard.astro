---
import type { LocalizedItem } from '../content/config';
import { normalizeLocale } from '../i18n/site';
import { getTypes, at } from '../lib/content';
import { throwf } from '../lib/util';
import Graphic from './Graphic';

function buildDefinitionTitle(entry: LocalizedItem<'definitions'>): string {
    const abbr = entry.name.abbr;
    return abbr ? `${entry.name.full} (${abbr})` : entry.name.full;
}

function formatTitle(fmt: string, title: string): string {
    return fmt.replace('%s', title);
}
interface Props {
    definition: LocalizedItem<'definitions'>;
    langLabels: {
        fmtTitle: string;
    };
}
const { definition, langLabels } = Astro.props;
const definitionTitle = buildDefinitionTitle(definition);
const logoTitle = formatTitle(langLabels.fmtTitle, definitionTitle);
const backgroundStyle = definition.background ? `--bg-img-card: url(${definition.background})` : undefined;

const defType =
    at(await getTypes(normalizeLocale(Astro.currentLocale)), definition.type) ??
    throwf(`type of id ${definition.type} not found`);
const typeName = defType.title ?? definition.type;
---

<article class='definition' style={backgroundStyle}>
    <h4>
        <a class='foil' target='_blank' rel='noopener noreferrer' href={definition.wiki}>
            {definitionTitle}
        </a>
    </h4>
    {definition.logo ? <Graphic of={definition.logo} title={logoTitle} class='logo' /> : null}
    <p class='type'><small>{typeName.charAt(0).toUpperCase() + typeName.slice(1)}</small></p>
    <p class='synopsis' set:html={definition.synopsis} />
</article>
