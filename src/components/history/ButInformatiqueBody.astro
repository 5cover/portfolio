---
import ProjectCardList from '../ProjectCardList.astro';
import { getAnchors, getProjects, getTags, mapById } from '../../lib/content';
import { getLabels, normalizeLocale } from '../../i18n/site';
import Section, { type TSection } from '../Section.astro';
import type { Copy } from '../../lib/ui-types';

const MaxProjectsPerSkill = 4;

const SkillNames = ['realiser', 'optimiser', 'administrer', 'gerer', 'conduire', 'collaborer'] as const;
type SkillName = (typeof SkillNames)[number];
const YearTags = ['but-1', 'but-2', 'but-3'] as const;
type YearTag = (typeof YearTags)[number];

interface Props {
    skills: Record<SkillName, Record<'name' | 'desc', Copy>>;
    years: Record<
        YearTag,
        Record<'label' | 'title' | 'description' | 'bilan', Copy> & {
            skills: Record<SkillName, { ac: Copy[] }>;
        }
    >;
    copy: {
        yearTabsLabel: string;
        synthesisHeading: Copy;
        yearLabel: Copy;
        logoAlt: string;
        linkTextSyllabus: Copy;
        skillsAbstract: Copy;
        skill: (i: number, name: Copy) => Copy;
        iutAlt: string;
        presentation: Copy;
        heading: Copy;
        iutCaption: Copy;
    };
}

function simpleEntries<K extends PropertyKey, V>(o: Record<K, V>) {
    return Object.entries(o) as [K, V][];
}

const { copy, skills, years } = Astro.props as Props;

const locale = normalizeLocale(Astro.currentLocale);
const labels = getLabels(locale);
const [projects, tags, anchors] = await Promise.all([getProjects(locale), getTags(locale), getAnchors()]);

const tagsById = mapById(tags);
const anchorsById = mapById(anchors);
---

<Section class:list={['but-body', 'margined']} heading={copy.heading}>
    <header id='titre' slot='header'>
        <slot/>
        <img
            src='/portfolio/img/but.webp'
            alt={copy.logoAlt}
            width='95'
            height='96'
            loading='lazy'
            title={copy.logoAlt}
        />
    </header>
    {(Section: TSection) =>
    <article id='presentation'>{copy.presentation}</article>
    <a
        class='lvl button-link'
        target='_blank'
        rel='noopener noreferrer'
        href='https://www.enseignementsup-recherche.gouv.fr/sites/default/files/annexe-2-licence-professionnelle-bachelor-universitaire-de-technologie-informatique-29016.pdf'>
        {copy.linkTextSyllabus}
    </a>
    <section id='progression'>
        <h2>{copy.yearTabsLabel}</h2>
        <p>{copy.skillsAbstract}</p>
        <div class='tabs' data-tabs='but-years'>
            <div class='tablist' role='tablist' aria-label={copy.yearTabsLabel}>
                {
                    Object.entries(years).map(([id, year], i) => (
                        <button
                            type='button'
                            role='tab'
                            id={`tab-${id}`}
                            aria-controls={`panel-${id}`}
                            aria-selected={i === 0 ? 'true' : 'false'}
                            tabindex={i === 0 ? 0 : -1}>
                            {year.label}
                        </button>
                    ))
                }
            </div>
            {
                Object.entries(years).map(([yearName, year], i) => (
                    <section
                        id={`panel-${yearName}`}
                        role='tabpanel'
                        aria-labelledby={`tab-${yearName}`}
                        style={i === 0 ? '' : 'display:none'}>
                        <h3>
                            {copy.yearLabel} {i + 1} &mdash; {year.title}
                        </h3>
                        <p class='year-description'>{year.description}</p>
                        <p class='year-bilan'>
                            <em>{year.bilan}</em>
                        </p>
                        <ul class='year-skills lvl'>
                            {simpleEntries(year.skills).map(([skillName, skillYear], i) => {
                                const skillTag = `but-${skillName}`;
                                const skillProjects = projects
                                    .filter(
                                        project =>
                                            project.data.tags.includes(yearName) && project.data.tags.includes(skillTag)
                                    )
                                    .slice(0, MaxProjectsPerSkill);
                                return (
                                    <li
                                        style={`--bg-img: url(/portfolio/img/skill/${skillName}.jpg)`}
                                        class='year-skill'>
                                        <h3>{copy.skill(i + 1, skills[skillName].name)}</h3>
                                        <p>{skills[skillName].desc}</p>
                                        <ul class='apprentissages'>
                                            {skillYear.ac.map(item => (
                                                <li>{item}</li>
                                            ))}
                                        </ul>
                                        {skillProjects.length > 0 ? (
                                            <ProjectCardList
                                                langLabels={{
                                                    ongoing: labels.labels.ongoing,
                                                    fmtTitle: labels.labels.fmtTitle,
                                                }}
                                                projects={skillProjects}
                                                tagsById={tagsById}
                                                anchorsById={anchorsById}
                                                headingLevel={4}
                                                class='project-skills'
                                            />
                                        ) : null}
                                    </li>
                                );
                            })}
                        </ul>
                    </section>
                ))
            }
        </div>
    </section>
    <div class='lvl'>
        <article id='resultat-pour-moi'>
            <h2>{copy.synthesisHeading}</h2>
            <slot />
        </article>
        <figure class='figure'>
            <img
                src='/portfolio/img/iut-lannion.jpg'
                alt={copy.iutAlt}
                width='1200'
                height='630'
                loading='lazy'
                title={copy.iutAlt}
            />
            <figcaption>{copy.iutCaption}</figcaption>
        </figure>
    </div>
    }
</Section>
<script>
    // todo: clean this up, reuse helpers, external scripts
    const root = document.querySelector('.but-body [data-tabs="but-years"]');
    if (!root) throw Error('not found: .but-body [data-tabs="but-years"]');

    const tabs = Array.from(root.querySelectorAll('[role="tab"]')) as HTMLElement[];
    const panels = Array.from(root.querySelectorAll('[role="tabpanel"]')) as HTMLElement[];
    const activateTab = (tab: HTMLElement) => {
        tabs.forEach(item => {
            const isActive = item === tab;
            item.setAttribute('aria-selected', String(isActive));
            item.tabIndex = isActive ? 0 : -1;
        });
        panels.forEach(panel => {
            panel.style.display = panel.getAttribute('aria-labelledby') !== tab.id ? 'none' : '';
        });
    };
    tabs.forEach(tab => {
        tab.addEventListener('click', () => activateTab(tab));
    });
    root.addEventListener('keydown', event => {
        const e = event as KeyboardEvent;
        if (!(e.target instanceof HTMLElement)) {
            return;
        }
        if (e.target.getAttribute('role') !== 'tab') {
            return;
        }
        const currentIndex = tabs.indexOf(e.target);
        if (currentIndex < 0) {
            return;
        }
        let nextIndex = currentIndex;
        if (e.key === 'ArrowRight') {
            nextIndex = (currentIndex + 1) % tabs.length;
        } else if (e.key === 'ArrowLeft') {
            nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        } else if (e.key === 'Home') {
            nextIndex = 0;
        } else if (e.key === 'End') {
            nextIndex = tabs.length - 1;
        } else {
            return;
        }
        e.preventDefault();
        const nextTab = tabs[nextIndex];
        if (nextTab) {
            nextTab.focus();
            activateTab(nextTab);
        }
    });
</script>
