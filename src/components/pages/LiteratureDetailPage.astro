---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TextualContent from '../TextualContent.astro';
import Gallery from '../Gallery.astro';
import Graphic from '../Graphic.astro';
import LinkList from '../LinkList.astro';
import ReferenceList from '../ReferenceList.astro';

import type { AstroComponentFactory } from 'astro';
import { getAnchors, getLangData, getLangs, mapById } from '../../lib/content';
import type { LocalizedLiteratureEntry } from '../../lib/content';
import type { LangEntry } from '../../lib/content';
import { buildLanguages, buildNavItems, buildThemeLabels } from '../../lib/ui';

type Copy = {
    links: string;
    story: string;
    references: string;
    gallery: string;
    fmtTitle: string;
    refJumpUp: string;
};

type Props = {
    lang: string;
    langData: LangEntry['data'];
    route: string;
    entry: LocalizedLiteratureEntry;
    Body: AstroComponentFactory;
    copy: Copy;
    mainClass?: string;
};

const props: Props = Astro.props;
const {
    lang,
    langData,
    route,
    entry,
    Body,
    copy,
    mainClass,
} = props;

const navItems = buildNavItems(langData);
const themeLabels = buildThemeLabels(langData);
const langs = await getLangs();
const langMap = Object.fromEntries(await Promise.all(langs.map(async code => [code, await getLangData(code)])));
const languages = buildLanguages(langs, langMap);
const siteDescription = langData.siteDescription;
const githubTitle = langData.footerGitHubAnchorTitle;

const entryData = entry.data;
const anchorsById = mapById(await getAnchors());
const backgroundStyle = entryData.background ? `--bg-img: url(${entryData.background})` : undefined;
const logoTitle = copy.fmtTitle.replace('%s', entryData.title);
---

<BaseLayout
    lang={lang}
    pageName={`${route}/${entry.id}`}
    navItems={navItems}
    languages={languages}
    themeLabels={themeLabels}
    siteDescription={siteDescription}
    githubTitle={githubTitle}
>
    <main style={backgroundStyle} class={mainClass}>
        <header>
            <h1 set:html={entryData.title}></h1>
            {entryData.logo ? (
                <Graphic
                    url={entryData.logo.url}
                    isThemedSvg={entryData.logo.isThemedSvg}
                    alt={logoTitle}
                    title={logoTitle}
                    class="logo"
                />
            ) : null}
            <p class="abstract" set:html={entryData.abstract}></p>
        </header>
        {entryData.links.length > 0 ? (
            <section id="links">
                <h2>{copy.links}</h2>
                <LinkList links={entryData.links} anchorsById={anchorsById} variant="page" />
            </section>
        ) : null}
        <section id="story">
            <h2>{copy.story}</h2>
            <TextualContent content={Body} />
        </section>
        {entryData.references.length > 0 ? (
            <section id="references">
                <h2>{copy.references}</h2>
                <ReferenceList
                    references={entryData.references}
                    anchorsById={anchorsById}
                    backlinkLabel={copy.refJumpUp}
                />
            </section>
        ) : null}
        {entryData.gallery.length > 0 ? (
            <section id="gallery">
                <h2>{copy.gallery}</h2>
                <Gallery items={entryData.gallery} />
            </section>
        ) : null}
    </main>
</BaseLayout>
