---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TextualContent from '../TextualContent.astro';
import Gallery from '../Gallery.astro';
import Graphic from '../Graphic';
import LinkList from '../LinkList';
import ReferenceList from '../ReferenceList.astro';
import { getAnchors, getLiterature, getTextualEntry, mapById } from '../../lib/content';
import { getLabels, normalizeLocale } from '../../i18n/site';

type Props = {
    route: string;
    id: string;
    mainClass?: string;
};
const { route, id, mainClass } = Astro.props;

const locale = normalizeLocale(Astro.currentLocale);
const copy = getLabels(locale).labels;

const literatures = await getLiterature(locale);
const entry = literatures.find(item => item.id === id);
if (!entry) {
    throw new Error(`Missing literature ${id} for ${locale}`);
}

const body = await getTextualEntry(locale, 'literature', entry.id);
const { Content: Body } = await body.render();

const anchorsById = mapById(await getAnchors());
const backgroundStyle = entry.data.background ? `--bg-img: url(${entry.data.background})` : undefined;
const logoTitle = copy.fmtTitle.replace('%s', entry.data.title);
---

<BaseLayout pageName={`${route}/${entry.id}`}>
    <main style={backgroundStyle} class={mainClass}>
        <header>
            <h1 set:html={entry.data.title} />
            {
                entry.data.logo ? (
                    <Graphic
                        of={entry.data.logo}
                        alt={logoTitle}
                        title={logoTitle}
                        class='logo'
                    />
                ) : null
            }
            <p class='abstract' set:html={entry.data.abstract} />
        </header>
        {
            entry.data.links.length > 0 ? (
                <section id='links'>
                    <h2>{copy.links}</h2>
                    <LinkList links={entry.data.links} anchorsById={anchorsById} variant='page' />
                </section>
            ) : null
        }
        <section id='story'>
            <h2>{copy.story}</h2>
            <TextualContent content={Body} />
        </section>
        {
            entry.data.references.length > 0 ? (
                <section id='references'>
                    <h2>{copy.references}</h2>
                    <ReferenceList
                        references={entry.data.references}
                        anchorsById={anchorsById}
                        backlinkLabel={copy.refJumpUp}
                    />
                </section>
            ) : null
        }
        {
            entry.data.gallery.length > 0 ? (
                <section id='gallery'>
                    <h2>{copy.gallery}</h2>
                    <Gallery items={entry.data.gallery} />
                </section>
            ) : null
        }
    </main>
</BaseLayout>
