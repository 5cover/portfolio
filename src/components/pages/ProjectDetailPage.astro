---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TextualContent from '../TextualContent.astro';
import DefinitionCardList from '../DefinitionCardList.astro';
import Gallery from '../Gallery.astro';
import Graphic from '../Graphic';
import LinkList from '../LinkList';
import ReferenceList from '../ReferenceList.astro';

import type { AstroComponentFactory } from 'astro';
import { getAnchors, getDefinitions, getTags, getTypes, mapById } from '../../lib/content';
import type { DefinitionLocalizedData, LocalizedProjectEntry } from '../../lib/content';
import { formatDate } from '../../lib/date';
import { pageHref } from '../../lib/links';
import { normalizeLocale } from '../../i18n/site';

import '../../styles/project.scss';

type Copy = {
    links: string;
    team: string;
    story: string;
    references: string;
    technologies: string;
    gallery: string;
    ongoing: string;
    fmtTitle: string;
    refJumpUp: string;
};

type Props = {
    project: LocalizedProjectEntry;
    ProjectBody: AstroComponentFactory;
    copy: Copy;
};

const props: Props = Astro.props;
const { project, ProjectBody, copy } = props;

function isDefinition(value: DefinitionLocalizedData | undefined): value is DefinitionLocalizedData {
    return Boolean(value);
}

const locale = normalizeLocale(Astro.currentLocale);
const [tags, anchors, definitions, types] = await Promise.all([
    getTags(locale),
    getAnchors(),
    getDefinitions(locale),
    getTypes(locale),
]);
const tagsById = mapById(tags);
const anchorsById = mapById(anchors);
const definitionsById = mapById(definitions);
const typesById = mapById(types);

const projectData = project.data;
const backgroundStyle = projectData.background ? `--bg-img: url(${projectData.background})` : undefined;
const logoTitle = copy.fmtTitle.replace('%s', projectData.title);
const startDate = projectData.startDate;
const endDate = projectData.endDate;
const startLabel = startDate ? formatDate(startDate, locale) : '';
const endLabel = endDate ? formatDate(endDate, locale) : '';
const context = projectData.context ? projectData.context.charAt(0).toUpperCase() + projectData.context.slice(1) : '';

const teamDefs = projectData.team.map(memberId => definitionsById[memberId]).filter(isDefinition);
const techDefs = projectData.technologies.map(techId => definitionsById[techId]).filter(isDefinition);
---

<BaseLayout pageName={`projects/${project.id}`}>
    <main style={backgroundStyle}>
        <header>
            <ul class='list-rect'>
                {
                    projectData.tags.map(tagId => (
                        <li>
                            <a
                                href={`${pageHref(locale, 'projects')}?tag=${tagId}`}
                                set:html={tagsById[tagId]?.title ?? tagId}
                            />
                        </li>
                    ))
                }
            </ul>
            <h1 set:html={projectData.title} />
            {projectData.logo ? <Graphic of={projectData.logo} alt={logoTitle} title={logoTitle} class='logo' /> : null}
            <p class='abstract' set:html={projectData.abstract} />
            <div class='status-context'>
                {context ? <small class='context'>{context}</small> : null}
                {
                    startDate ? (
                        <small class='status'>
                            <time datetime={startDate}>{startLabel}</time> &ndash;{' '}
                            {endDate ? <time datetime={endDate}>{endLabel}</time> : copy.ongoing}
                        </small>
                    ) : null
                }
            </div>
        </header>
        {
            projectData.links.length > 0 ? (
                <section id='links'>
                    <h2>{copy.links}</h2>
                    <LinkList links={projectData.links} anchorsById={anchorsById} variant='page' />
                </section>
            ) : null
        }
        {
            teamDefs.length > 0 ? (
                <section id='team'>
                    <h2>{copy.team}</h2>
                    <DefinitionCardList
                        definitions={teamDefs}
                        typesById={typesById}
                        langLabels={{ fmtTitle: copy.fmtTitle }}
                    />
                </section>
            ) : null
        }
        <section id='story'>
            <h2>{copy.story}</h2>
            <TextualContent content={ProjectBody} />
        </section>
        {
            projectData.references.length > 0 ? (
                <section id='references'>
                    <h2>{copy.references}</h2>
                    <ReferenceList
                        references={projectData.references}
                        anchorsById={anchorsById}
                        backlinkLabel={copy.refJumpUp}
                    />
                </section>
            ) : null
        }
        {
            techDefs.length > 0 ? (
                <section id='technologies'>
                    <h2>{copy.technologies}</h2>
                    <DefinitionCardList
                        definitions={techDefs}
                        typesById={typesById}
                        langLabels={{ fmtTitle: copy.fmtTitle }}
                    />
                </section>
            ) : null
        }
        {
            projectData.gallery.length > 0 ? (
                <section id='gallery'>
                    <h2>{copy.gallery}</h2>
                    <Gallery items={projectData.gallery} />
                </section>
            ) : null
        }
    </main>
</BaseLayout>
