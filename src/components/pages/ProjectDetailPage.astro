---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TextualContent from '../TextualContent.astro';
import DefinitionCardList from '../DefinitionCardList.astro';
import Gallery from '../Gallery.astro';
import Graphic from '../Graphic';
import LinkList from '../LinkList';
import ReferenceList from '../ReferenceList.astro';

import { at, getDefinitions, getProjects, getTags, getTextualEntry, mapById } from '../../lib/content';
import { formatDate } from '../../lib/date';
import { pageHref } from '../../lib/links';
import { getLabels, normalizeLocale } from '../../i18n/site';

import '../../styles/project.scss';

interface Props {
    id: string;
}

const { id } = Astro.props;

const locale = normalizeLocale(Astro.currentLocale);

const [tags, definitions] = await Promise.all([getTags(locale), getDefinitions(locale)]);
const tagsById = mapById(tags);
const definitionsById = mapById(definitions);
const labels = getLabels(locale);

const p = at(await getProjects(locale), id);
if (!p) {
    throw new Error(`Missing project ${id} for ${locale}`);
}

const projectBodyEntry = await getTextualEntry(locale, 'projects', id);
const { Content: ProjectBody } = await projectBodyEntry.render();

const backgroundStyle = p.background ? `--bg-img: url(${p.background})` : undefined;
const logoTitle = labels.copy.fmtTitle.replace('%s', p.title);
const startDate = p.startDate;
const endDate = p.endDate;
const startLabel = startDate ? formatDate(startDate, locale) : '';
const endLabel = endDate ? formatDate(endDate, locale) : '';
const context = p.context ? p.context.charAt(0).toUpperCase() + p.context.slice(1) : '';
const teamDefs = p.team.map(memberId => definitionsById[memberId]);
const techDefs = p.technologies.map(techId => definitionsById[techId]);
---

<BaseLayout pageName={`projects/${id}`}>
    <main style={backgroundStyle}>
        <header>
            <ul class='list-rect'>
                {
                    p.tags.map(tagId => (
                        <li>
                            <a
                                href={`${pageHref(locale, 'projects')}?tag=${tagId}`}
                                set:html={tagsById[tagId]?.title ?? tagId}
                            />
                        </li>
                    ))
                }
            </ul>
            <h1 set:html={p.title} />
            {p.logo ? <Graphic of={p.logo} alt={logoTitle} title={logoTitle} class='logo' /> : null}
            <p class='abstract' set:html={p.abstract} />
            <div class='status-context'>
                {context ? <small class='context'>{context}</small> : null}
                {
                    startDate ? (
                        <small class='status'>
                            <time datetime={startDate}>{startLabel}</time> &ndash;{' '}
                            {endDate ? <time datetime={endDate}>{endLabel}</time> : labels.copy.ongoing}
                        </small>
                    ) : null
                }
            </div>
        </header>
        {
            p.links.length > 0 ? (
                <section id='links'>
                    <h2>{labels.copy.links}</h2>
                    <LinkList links={p.links} variant='page' />
                </section>
            ) : null
        }
        {
            teamDefs.length > 0 ? (
                <section id='team'>
                    <h2>{labels.copy.team}</h2>
                    <DefinitionCardList definitions={teamDefs} langLabels={{ fmtTitle: labels.copy.fmtTitle }} />
                </section>
            ) : null
        }
        <section id='story'>
            <h2>{labels.copy.story}</h2>
            <TextualContent content={ProjectBody} />
        </section>
        {
            p.references.length > 0 ? (
                <section id='references'>
                    <h2>{labels.copy.references}</h2>
                    <ReferenceList references={p.references} backlinkLabel={labels.copy.refJumpUp} />
                </section>
            ) : null
        }
        {
            techDefs.length > 0 ? (
                <section id='technologies'>
                    <h2>{labels.copy.technologies}</h2>
                    <DefinitionCardList definitions={techDefs} langLabels={{ fmtTitle: labels.copy.fmtTitle }} />
                </section>
            ) : null
        }
        {
            p.gallery.length > 0 ? (
                <section id='gallery'>
                    <h2>{labels.copy.gallery}</h2>
                    <Gallery items={p.gallery} />
                </section>
            ) : null
        }
    </main>
</BaseLayout>
