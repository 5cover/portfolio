---
import LiteratureDetailPage from '../../../components/pages/LiteratureDetailPage.astro';
import {
  getAnchors,
  getLangData,
  getLangs,
  getLiterature,
  getTextualEntry,
  mapById,
} from '../../../lib/content';
import { buildLanguages, buildNavItems, buildThemeLabels } from '../../../lib/ui';

import '../../../styles/perspective.scss';

export async function getStaticPaths() {
  const langs = await getLangs();
  const paths = await Promise.all(
    langs.map(async (lang) => {
      const entries = await getLiterature(lang);
      return entries
        .filter((entry) => entry.data.kind === 'blog')
        .map((entry) => ({ params: { lang, id: entry.id } }));
    })
  );

  return paths.flat();
}

const { lang, id } = Astro.params;
if (!lang || !id) {
  throw new Error('Missing route params');
}

const [langData, langs, literature, anchors] = await Promise.all([
  getLangData(lang),
  getLangs(),
  getLiterature(lang),
  getAnchors(),
]);

const entry = literature.find((item) => item.id === id && item.data.kind === 'blog');
if (!entry) {
  throw new Error(`Missing blog ${id} for ${lang}`);
}

const blogBodyEntry = await getTextualEntry(lang, 'literature', entry.id);
const { Content: BlogBody } = await blogBodyEntry.render();

const navItems = buildNavItems(langData);
const themeLabels = buildThemeLabels(langData);
const langMap = Object.fromEntries(
  await Promise.all(langs.map(async (code) => [code, await getLangData(code)]))
);
const languages = buildLanguages(langs, langMap);
const anchorsById = mapById(anchors);

const blog = entry.data;
---
<LiteratureDetailPage
  lang={lang}
  id={id}
  pageName={`blog/${id}`}
  navItems={navItems}
  languages={languages}
  themeLabels={themeLabels}
  siteDescription={langData.siteDescription}
  githubTitle={langData.footerGitHubAnchorTitle}
  entry={blog}
  anchorsById={anchorsById}
  Body={BlogBody}
  copy={{
    links: langData.links,
    story: langData.story,
    references: langData.references,
    gallery: langData.gallery,
    fmtTitle: langData.fmtTitle,
    refJumpUp: langData.refJumpUp,
  }}
/>
