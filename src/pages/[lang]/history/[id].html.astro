---
import HistoryDetailPage from '../../../components/pages/HistoryDetailPage.astro';
import { getHistory, getLangData, getLangs, getTextualEntry } from '../../../lib/content';
import { buildLanguages, buildNavItems, buildThemeLabels } from '../../../lib/ui';


export async function getStaticPaths() {
    const langs = await getLangs();
    const paths = await Promise.all(
        langs.map(async lang => {
            const entries = await getHistory(lang);
            return entries.map(entry => ({ params: { lang, id: entry.id } }));
        })
    );

    return paths.flat();
}

const { lang, id } = Astro.params;
if (!lang || !id) {
    throw new Error('Missing route params');
}

const [langData, langs, historyEntries] = await Promise.all([
    getLangData(lang),
    getLangs(),
    getHistory(lang),
]);
const entry = historyEntries.find(item => item.id === id);
if (!entry) {
    throw new Error(`Missing history ${id} for ${lang}`);
}

const historySummaryEntry = await getTextualEntry(lang, 'history', entry.id);
const { Content: HistorySummary } = await historySummaryEntry.render();
const historyBodyEntry = await getTextualEntry(lang, 'history-body', entry.data.body ?? entry.id);
const { Content: HistoryBody } = await historyBodyEntry.render();

const navItems = buildNavItems(langData);
const themeLabels = buildThemeLabels(langData);
const langMap = Object.fromEntries(
    await Promise.all(langs.map(async code => [code, await getLangData(code)]))
);
const languages = buildLanguages(langs, langMap);

const detailsHeading = lang === 'fr' ? 'DÃ©tails' : 'Details';
---

<HistoryDetailPage
    lang={lang}
    navItems={navItems}
    languages={languages}
    themeLabels={themeLabels}
    siteDescription={langData.siteDescription}
    githubTitle={langData.footerGitHubAnchorTitle}
    entry={entry}
    HistorySummary={HistorySummary}
    HistoryBody={HistoryBody}
    copy={{
        story: langData.story,
        detailsHeading,
    }}
/>
