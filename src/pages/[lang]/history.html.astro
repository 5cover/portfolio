---
import HistoryIndexPage from '../../components/pages/HistoryIndexPage.astro';
import { getHistory, getLangData, getLangs, getTextualEntry } from '../../lib/content';
import { buildLanguages, buildNavItems, buildThemeLabels } from '../../lib/ui';

export async function getStaticPaths() {
    const langs = await getLangs();
    return langs.map(lang => ({ params: { lang } }));
}

const { lang } = Astro.params;
if (!lang) {
    throw new Error('Missing lang param');
}

const [langData, langs, historyItems] = await Promise.all([getLangData(lang), getLangs(), getHistory(lang)]);

const orderedHistory = [...historyItems].reverse();

const historyBodies = await Promise.all(
    orderedHistory.map(async entry => {
        const bodyEntry = await getTextualEntry(lang, 'history', entry.id);
        const { Content } = await bodyEntry.render();
        return Content;
    })
);

const navItems = buildNavItems(langData);
const themeLabels = buildThemeLabels(langData);
const langMap = Object.fromEntries(await Promise.all(langs.map(async code => [code, await getLangData(code)])));
const languages = buildLanguages(langs, langMap);
---

<HistoryIndexPage
    lang={lang}
    navItems={navItems}
    languages={languages}
    themeLabels={themeLabels}
    siteDescription={langData.siteDescription}
    githubTitle={langData.footerGitHubAnchorTitle}
    orderedHistory={orderedHistory}
    historyBodies={historyBodies}
/>
