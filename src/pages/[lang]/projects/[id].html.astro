---
import ProjectDetailPage from '../../../components/pages/ProjectDetailPage.astro';
import {
  getAnchors,
  getDefinitions,
  getLangData,
  getLangs,
  getProjects,
  getTags,
  getTextualEntry,
  getTypes,
  mapById,
} from '../../../lib/content';
import { buildLanguages, buildNavItems, buildThemeLabels } from '../../../lib/ui';

export async function getStaticPaths() {
  const langs = await getLangs();
  const paths = await Promise.all(
    langs.map(async (lang) => {
      const projects = await getProjects(lang);
      return projects.map((project) => ({
        params: { lang, id: project.id },
      }));
    })
  );

  return paths.flat();
}

const { lang, id } = Astro.params;
if (!lang || !id) {
  throw new Error('Missing route params');
}

const [langData, langs, projectEntry, tags, anchors, definitions, types] = await Promise.all([
  getLangData(lang),
  getLangs(),
  getProjects(lang).then((entries) => entries.find((entry) => entry.id === id)),
  getTags(lang),
  getAnchors(),
  getDefinitions(lang),
  getTypes(lang),
]);

if (!projectEntry) {
  throw new Error(`Missing project ${id} for ${lang}`);
}

const projectBodyEntry = await getTextualEntry(
  lang,
  'projects',
  projectEntry.id
);
const { Content: ProjectBody } = await projectBodyEntry.render();

const navItems = buildNavItems(langData);
const themeLabels = buildThemeLabels(langData);
const langMap = Object.fromEntries(
  await Promise.all(langs.map(async (code) => [code, await getLangData(code)]))
);
const languages = buildLanguages(langs, langMap);

const tagsById = mapById(tags);
const anchorsById = mapById(anchors);
const definitionsById = mapById(definitions);
const typesById = mapById(types);

const project = projectEntry.data;
---
<ProjectDetailPage
  lang={lang}
  id={id}
  navItems={navItems}
  languages={languages}
  themeLabels={themeLabels}
  siteDescription={langData.siteDescription}
  githubTitle={langData.footerGitHubAnchorTitle}
  project={project}
  tagsById={tagsById}
  anchorsById={anchorsById}
  definitionsById={definitionsById}
  typesById={typesById}
  ProjectBody={ProjectBody}
  copy={{
    links: langData.links,
    team: langData.team,
    story: langData.story,
    references: langData.references,
    technologies: langData.technologies,
    gallery: langData.gallery,
    ongoing: langData.ongoing,
    fmtTitle: langData.fmtTitle,
    refJumpUp: langData.refJumpUp,
  }}
/>
