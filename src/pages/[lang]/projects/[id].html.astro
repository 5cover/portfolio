---
import ProjectDetailPage from '../../../components/pages/ProjectDetailPage.astro';
import { getLangData, getLangs, getProjects, getTextualEntry } from '../../../lib/content';

export async function getStaticPaths() {
  const langs = await getLangs();
  const paths = await Promise.all(
    langs.map(async (lang) => {
      const projects = await getProjects(lang);
      return projects.map((project) => ({
        params: { lang, id: project.id },
      }));
    })
  );

  return paths.flat();
}

const { lang, id } = Astro.params;
if (!lang || !id) {
  throw new Error('Missing route params');
}

const [langData, projectEntry] = await Promise.all([
  getLangData(lang),
  getProjects(lang).then((entries) => entries.find((entry) => entry.id === id)),
]);

if (!projectEntry) {
  throw new Error(`Missing project ${id} for ${lang}`);
}

const projectBodyEntry = await getTextualEntry(
  lang,
  'projects',
  projectEntry.id
);
const { Content: ProjectBody } = await projectBodyEntry.render();

---
<ProjectDetailPage
  lang={lang}
  langData={langData}
  project={projectEntry}
  ProjectBody={ProjectBody}
  copy={{
    links: langData.links,
    team: langData.team,
    story: langData.story,
    references: langData.references,
    technologies: langData.technologies,
    gallery: langData.gallery,
    ongoing: langData.ongoing,
    fmtTitle: langData.fmtTitle,
    refJumpUp: langData.refJumpUp,
  }}
/>
